---
name: Documentation

on:
  push:
    branches: [main]
    paths:
      - docs/**
      - src/typing_graph/**/*.py
      - mkdocs.yml
      - pyproject.toml
      - wrangler.toml
      - justfile
      - package.json
      - pnpm-lock.yaml
      - .markdownlint-cli2.jsonc
      - .vale.ini
      - biome.json
      - .github/workflows/documentation.yml
  pull_request:
    branches: [main]
    paths:
      - docs/**
      - src/typing_graph/**/*.py
      - mkdocs.yml
      - pyproject.toml
      - wrangler.toml
      - justfile
      - package.json
      - pnpm-lock.yaml
      - .markdownlint-cli2.jsonc
      - .vale.ini
      - biome.json
      - .github/workflows/documentation.yml
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41 # v7.2.1
        with:
          python-version: "3.10"
          enable-cache: true

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        name: Install pnpm
        with:
          run_install: true

      - name: Install Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Lint documentation
        run: just lint-docs

  lint-prose:
    name: Lint prose
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Lint prose
        uses: errata-ai/vale-action@d89dee975228ae261d22c15adcd03578634d429c # v2.1.1
        with:
          version: 3.13.0
          # yamllint disable-line rule:line-length
          files: '["docs", "docs/llms.txt", "docs/llms-full.txt", "README.md", "CONTRIBUTING.md", "CODE_OF_CONDUCT.md", "SECURITY.md", "DEVELOPMENT.md", "TESTING.md", "RELEASING.md", ".github/pull_request_template.md"]'

  test:
    name: Test
    needs: [lint, lint-prose]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41 # v7.2.1
        with:
          python-version: "3.10"
          enable-cache: true

      - name: Install just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Run documentation tests
        run: just test-docs all

  deploy:
    name: Deploy
    needs:
      - test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: documentation
      # yamllint disable-line rule:line-length
      url: ${{ github.event_name == 'pull_request' && format('https://pr-{0}-typing-graph-docs-pr.tbhb.workers.dev/', github.event.pull_request.number) || 'https://typing-graph.tbhb.dev/' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41 # v7.2.1
        with:
          python-version: "3.10"
          enable-cache: true

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        name: Install pnpm
        with:
          run_install: true

      - name: Install Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Deploy documentation
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: just deploy-docs

      - name: Deploy documentation preview
        if: github.event_name == 'pull_request'
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: just deploy-docs-pr ${{ github.event.pull_request.number }}
